<!-- ============================================ NEW UI CODE ============================================= -->


<template>
    <AppLayout>
        <div class="p-6 md:p-8 space-y-6 max-h-[calc(100vh-14rem)] overflow-y-auto">

            <!-- Current Version Card -->
            <div class="group bg-white rounded-2xl border border-slate-200 hover:shadow-lg transition-all duration-300">
                <div class="bg-gradient-to-r from-slate-50 to-orange-50/30 px-6 py-4 border-b border-slate-200">
                    <div class="flex items-center gap-3">
                        <div
                            class="p-2 bg-gradient-to-br from-[#ff5100] to-[#ff7340] rounded-lg shadow-lg shadow-[#ff5100]/20">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                class="text-white">
                                <path fill="currentColor"
                                    d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10s10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5l1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z" />
                            </svg>
                        </div>
                        <div>
                            <h2 class="text-lg font-bold text-slate-900">{{ $t('Swiftchats Updates') }}</h2>
                            <div class="flex items-center gap-1.5 text-sm text-slate-600 mt-0.5">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24"
                                    class="text-[#ff5100]">
                                    <path fill="none" stroke="currentColor" stroke-linecap="round"
                                        stroke-linejoin="round" stroke-width="2"
                                        d="M12 11v5m0 5a9 9 0 1 1 0-18a9 9 0 0 1 0 18Zm.05-13v.1h-.1V8h.1Z" />
                                </svg>
                                <span>{{ $t('Check and manage your application updates') }}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="p-6 space-y-4">
                    <!-- Version Info -->
                    <div class="grid md:grid-cols-2 gap-4">
                        <div class="p-4 bg-gradient-to-br from-slate-50 to-white border-2 border-slate-200 rounded-xl">
                            <div class="text-xs font-semibold text-slate-600 uppercase tracking-wider mb-1">Current
                                Version</div>
                            <div class="text-2xl font-bold text-slate-900">v{{ version }}</div>
                        </div>
                        <div class="p-4 bg-gradient-to-br from-slate-50 to-white border-2 border-slate-200 rounded-xl">
                            <div class="text-xs font-semibold text-slate-600 uppercase tracking-wider mb-1">Released
                                Date</div>
                            <div class="text-2xl font-bold text-slate-900">{{ releaseDate }}</div>
                        </div>
                    </div>

                    <!-- Last Check Info -->
                    <div class="flex items-center justify-between p-4 rounded-xl bg-slate-50/50">
                        <div class="flex items-center gap-2 text-sm text-slate-600">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                class="text-[#ff5100]">
                                <path fill="currentColor"
                                    d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10a10 10 0 0 0 10-10A10 10 0 0 0 12 2m4.2 14.2L11 13V7h1.5v5.2l4.5 2.7z" />
                            </svg>
                            <span>Last checked on {{ getValueByKey('last_update_check') }}</span>
                        </div>
                        <button @click="submitForm3()" :disabled="form3.processing"
                            class="px-4 py-2 bg-gradient-to-r from-[#ff5100] to-[#ff7340] text-white font-semibold rounded-lg shadow-md hover:shadow-lg transition-all duration-200 disabled:opacity-50 flex items-center gap-2">
                            <svg v-if="form3.processing" xmlns="http://www.w3.org/2000/svg" width="18" height="18"
                                viewBox="0 0 24 24">
                                <path fill="currentColor"
                                    d="M12 2A10 10 0 1 0 22 12A10 10 0 0 0 12 2Zm0 18a8 8 0 1 1 8-8A8 8 0 0 1 12 20Z"
                                    opacity=".5" />
                                <path fill="currentColor" d="M20 12h2A10 10 0 0 0 12 2V4A8 8 0 0 1 20 12Z">
                                    <animateTransform attributeName="transform" dur="1s" from="0 12 12"
                                        repeatCount="indefinite" to="360 12 12" type="rotate" />
                                </path>
                            </svg>
                            <span v-else>Check Again</span>
                        </button>
                    </div>

                    <!-- Update Status -->
                    <div v-if="getValueByKey('is_update_available') == 0"
                        class="p-4 bg-gradient-to-r from-emerald-50 to-emerald-100/50 border-2 border-emerald-200 rounded-xl flex items-start gap-3">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                            class="text-emerald-600 flex-shrink-0 mt-0.5">
                            <path fill="currentColor"
                                d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10s10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5l1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z" />
                        </svg>
                        <p class="text-sm font-medium text-emerald-800">
                            {{ $t('You have installed the latest version of Swiftchats') }}
                        </p>
                    </div>

                    <!-- Update Available -->
                    <div v-else class="space-y-4">
                        <!-- Warning Alert -->
                        <div
                            class="p-4 bg-gradient-to-r from-orange-50 to-orange-100/50 border-2 border-orange-200 rounded-xl flex items-start gap-3">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                class="text-[#ff5100] flex-shrink-0 mt-0.5">
                                <path fill="currentColor"
                                    d="M12 11v5m0 5a9 9 0 1 1 0-18a9 9 0 0 1 0 18Zm.05-13v.1h-.1V8h.1Z" />
                            </svg>
                            <p class="text-sm font-medium text-gray-700">
                                <span class="font-bold">Important:</span> Before updating backup your database and files
                            </p>
                        </div>

                        <!-- Update Card -->
                        <div
                            class="p-4 bg-white border-2 border-slate-200 rounded-xl flex items-center justify-between hover:border-[#ff5100] transition-colors">
                            <div class="flex items-center gap-3">
                                <img class="h-10 w-10 rounded-lg" :src="'/images/logo.png'" alt="Swiftchats Logo">
                                <div>
                                    <div class="text-sm font-semibold text-slate-900">New Version Available</div>
                                    <div class="text-xs text-slate-600">v{{ getValueByKey('available_version') }}</div>
                                </div>
                            </div>
                            <button @click="openModal()"
                                class="px-5 py-2.5 bg-gradient-to-r from-[#ff5100] to-[#ff7340] text-white font-semibold rounded-lg shadow-md hover:shadow-lg transition-all duration-200">
                                {{ $t('Update to version') + ' ' + getValueByKey('available_version') }}
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Addons Card -->
            <div class="group bg-white rounded-2xl border border-slate-200 hover:shadow-lg transition-all duration-300">
                <div class="bg-gradient-to-r from-slate-50 to-orange-50/30 px-6 py-4 border-b border-slate-200">
                    <div class="flex items-center gap-3">
                        <div
                            class="p-2 bg-gradient-to-br from-[#ff5100] to-[#ff7340] rounded-lg shadow-lg shadow-[#ff5100]/20">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                class="text-white">
                                <path fill="currentColor"
                                    d="M20.5 11H19V7c0-1.1-.9-2-2-2h-4V3.5C13 2.12 11.88 1 10.5 1S8 2.12 8 3.5V5H4c-1.1 0-1.99.9-1.99 2v3.8H3.5c1.49 0 2.7 1.21 2.7 2.7s-1.21 2.7-2.7 2.7H2V20c0 1.1.9 2 2 2h3.8v-1.5c0-1.49 1.21-2.7 2.7-2.7c1.49 0 2.7 1.21 2.7 2.7V22H17c1.1 0 2-.9 2-2v-4h1.5c1.38 0 2.5-1.12 2.5-2.5S21.88 11 20.5 11z" />
                            </svg>
                        </div>
                        <div>
                            <h2 class="text-lg font-bold text-slate-900">{{ $t('Addons') }}</h2>
                            <div class="flex items-center gap-1.5 text-sm text-slate-600 mt-0.5">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24"
                                    class="text-[#ff5100]">
                                    <path fill="none" stroke="currentColor" stroke-linecap="round"
                                        stroke-linejoin="round" stroke-width="2"
                                        d="M12 11v5m0 5a9 9 0 1 1 0-18a9 9 0 0 1 0 18Zm.05-13v.1h-.1V8h.1Z" />
                                </svg>
                                <span>{{ $t('Manage your addon updates') }}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="p-6">
                    <!-- No Addons Message -->
                    <div v-if="rows.data.length == 0"
                        class="p-4 bg-gradient-to-r from-emerald-50 to-emerald-100/50 border-2 border-emerald-200 rounded-xl flex items-start gap-3">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                            class="text-emerald-600 flex-shrink-0 mt-0.5">
                            <path fill="currentColor"
                                d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10s10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5l1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z" />
                        </svg>
                        <p class="text-sm font-medium text-emerald-800">
                            {{ $t('Your addons are all upto date.') }}
                        </p>
                    </div>

                    <!-- Addons Grid -->
                    <div v-else class="grid md:grid-cols-2 gap-4">
                        <div v-for="addon in rows.data" :key="addon.id"
                            class="p-4 bg-white border-2 border-slate-200 rounded-xl flex items-center justify-between hover:border-[#ff5100] transition-all duration-200">
                            <div class="flex items-center gap-3">
                                <img class="h-10 w-10 rounded-lg" :src="'/images/' + addon.logo" :alt="addon.name">
                                <span class="text-sm font-semibold text-slate-900">{{ addon.name }}</span>
                            </div>
                            <button v-if="getValueByKey('is_update_available') == 0" @click="updateAddon(addon)"
                                class="px-4 py-2 bg-gradient-to-r from-[#ff5100] to-[#ff7340] text-white font-semibold rounded-lg shadow-md hover:shadow-lg transition-all duration-200 text-sm">
                                Update
                            </button>
                            <div v-else
                                class="px-4 py-2 bg-gradient-to-r from-red-600 to-red-700 text-white rounded-lg flex items-center gap-2 text-sm">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24">
                                    <path fill="currentColor"
                                        d="M12 11v5m0 5a9 9 0 1 1 0-18a9 9 0 0 1 0 18Zm.05-13v.1h-.1V8h.1Z" />
                                </svg>
                                <span>{{ $t('Update script first') }}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Pagination -->
                    <Pagination class="mt-6" :pagination="rows.meta" />
                </div>
            </div>
        </div>

        <!-- Update Addon Modal -->
        <Modal :isOpen="isUpdateModal">
            <div class="grid grid-cols-1 gap-x-6 gap-y-4">
                <div
                    class="bg-gradient-to-r from-slate-50 to-orange-50/30 mx-[-30px] px-6 mt-[-25px] py-4 border-b border-slate-200">
                    <div class="flex items-center gap-3">
                        <img class="h-10 w-10 rounded-lg" :src="'/images/' + modalLogo" alt="Addon Logo">
                        <div class="text-lg font-bold text-slate-900">{{ $t(modalTitle) }}</div>
                    </div>
                </div>

                <form @submit.prevent="submitForm()">
                    <div class="space-y-4">
                        <div>
                            <div class="text-base font-bold text-slate-900 mb-2">{{ $t('Update module') }}</div>
                            <p class="text-sm text-slate-600">{{ $t(`A new version is available. Would you like to
                                proceed with updating the module?`) }}</p>
                        </div>

                        <div class="pt-4 border-t border-slate-200 flex gap-3">
                            <button type="button" @click="isUpdateModal = false"
                                class="px-6 py-2.5 bg-slate-100 hover:bg-slate-200 text-slate-700 font-medium rounded-lg transition-all duration-200">
                                {{ $t('No, not now') }}
                            </button>
                            <button type="submit"
                                class="px-6 py-2.5 bg-gradient-to-r from-[#ff5100] to-[#ff7340] text-white font-semibold rounded-lg shadow-md hover:shadow-lg transition-all duration-200 disabled:opacity-50 flex items-center gap-2"
                                :disabled="form.processing">
                                <svg v-if="form.processing" xmlns="http://www.w3.org/2000/svg" width="18" height="18"
                                    viewBox="0 0 24 24">
                                    <path fill="currentColor"
                                        d="M12 2A10 10 0 1 0 22 12A10 10 0 0 0 12 2Zm0 18a8 8 0 1 1 8-8A8 8 0 0 1 12 20Z"
                                        opacity=".5" />
                                    <path fill="currentColor" d="M20 12h2A10 10 0 0 0 12 2V4A8 8 0 0 1 20 12Z">
                                        <animateTransform attributeName="transform" dur="1s" from="0 12 12"
                                            repeatCount="indefinite" to="360 12 12" type="rotate" />
                                    </path>
                                </svg>
                                <span v-else>{{ $t('Yes, run the update') }}</span>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </Modal>

        <!-- Update Swiftchats Modal -->
        <Modal :isOpen="isOpenUpdateModal">
            <div class="grid grid-cols-1 gap-x-6 gap-y-4">
                <div
                    class="bg-gradient-to-r from-slate-50 to-orange-50/30 mx-[-30px] px-6 mt-[-25px] py-4 border-b border-slate-200">
                    <div class="flex items-center gap-3">
                        <div class="p-2 bg-gradient-to-br from-[#ff5100] to-[#ff7340] rounded-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                class="text-white">
                                <path fill="currentColor"
                                    d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10s10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5l1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z" />
                            </svg>
                        </div>
                        <div class="text-lg font-bold text-slate-900">{{ $t('Update to the latest version') }}</div>
                    </div>
                </div>

                <form @submit.prevent="submitForm2()">
                    <div class="space-y-4">
                        <p class="text-sm text-slate-600">{{ $t('Would you like to proceed with updating Swiftchats?')
                            }}</p>

                        <div class="pt-4 border-t border-slate-200 flex gap-3">
                            <button type="button" @click="isOpenUpdateModal = false"
                                class="px-6 py-2.5 bg-slate-100 hover:bg-slate-200 text-slate-700 font-medium rounded-lg transition-all duration-200">
                                {{ $t('No, not now') }}
                            </button>
                            <button type="submit"
                                class="px-6 py-2.5 bg-gradient-to-r from-[#ff5100] to-[#ff7340] text-white font-semibold rounded-lg shadow-md hover:shadow-lg transition-all duration-200 disabled:opacity-50 flex items-center gap-2"
                                :disabled="form2.processing">
                                <svg v-if="form2.processing" xmlns="http://www.w3.org/2000/svg" width="18" height="18"
                                    viewBox="0 0 24 24">
                                    <path fill="currentColor"
                                        d="M12 2A10 10 0 1 0 22 12A10 10 0 0 0 12 2Zm0 18a8 8 0 1 1 8-8A8 8 0 0 1 12 20Z"
                                        opacity=".5" />
                                    <path fill="currentColor" d="M20 12h2A10 10 0 0 0 12 2V4A8 8 0 0 1 20 12Z">
                                        <animateTransform attributeName="transform" dur="1s" from="0 12 12"
                                            repeatCount="indefinite" to="360 12 12" type="rotate" />
                                    </path>
                                </svg>
                                <span v-else>{{ $t('Yes, run the update') }}</span>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </Modal>
    </AppLayout>
</template>

<script setup>
import AppLayout from "./Layout/App.vue";
import { computed, ref } from 'vue';
import { useForm, usePage } from "@inertiajs/vue3";
import Modal from '@/Components/Modal.vue';
import Pagination from '@/Components/Pagination.vue';

const props = defineProps({
    config: {
        type: Object,
        required: true
    },
    rows: {
        type: Array,
        required: true
    }
});

const version = computed(() => usePage().props.applicationVersion);
const releaseDate = computed(() => usePage().props.applicationReleaseDate);
const modalLogo = ref(null);
const modalTitle = ref(null);
const modalDescription = ref(null);
const isCheckLoading = ref(false);
const isOpenUpdateModal = ref(false);
const isUpdateModal = ref(false);

const getValueByKey = (key) => {
    const found = props.config.find(item => item.key === key);
    return found ? found.value : '';
};

const form = useForm({
    uuid: null,
    purchase_code: null,
    addon: null,
    name: null,
});

const form2 = useForm({
    update: true
});

const form3 = useForm({
    checkUpdate: true
});

const openModal = () => {
    isOpenUpdateModal.value = true
}

const updateAddon = (item) => {
    modalLogo.value = item.logo;
    modalTitle.value = item.name;
    modalDescription.value = item.description;
    const metadata = item.metadata ? JSON.parse(item.metadata) : null;
    form.uuid = item.uuid
    form.name = item.name;
    form.addon = metadata?.name || item.name;
    isUpdateModal.value = true
}

const submitForm = () => {
    form.post('/admin/addons/update', {
        preserveScroll: true,
        onSuccess: () => {
            isUpdateModal.value = false
        }
    });
}

const submitForm2 = () => {
    form2.post('/admin/update', {
        preserveScroll: true,
        onSuccess: () => {
            isOpenUpdateModal.value = false
        }
    });
}

const submitForm3 = () => {
    form3.get('/admin/updates/check', {
        preserveScroll: true,
        onSuccess: () => {
            isCheckLoading.value = false
        }
    });
}
</script>