<!-- ========================================= NEW UI CODE ==================================== -->

<template>
    <AppLayout>
        <div class="min-h-screen bg-gradient-to-br from-gray-50 to-orange-50/30 p-4 md:p-8">
            <!-- Header Section for Create -->
            <div v-if="props.user === null" class="mb-8">
                <div class="bg-white rounded-3xl shadow-md border-2 border-primary/10 p-6 md:p-8">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                        <div class="flex items-center space-x-4">
                            <div
                                class="w-14 h-14 bg-gradient-to-br from-[#ff5100] to-[#ff7733] rounded-2xl flex items-center justify-center shadow-lg">
                                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24"
                                    class="text-white">
                                    <path fill="currentColor"
                                        d="M15 12c2.21 0 4-1.79 4-4s-1.79-4-4-4s-4 1.79-4 4s1.79 4 4 4zm-9-2V7H4v3H1v2h3v3h2v-3h3v-2H6zm9 4c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" />
                                </svg>
                            </div>
                            <div>
                                <h1 class="text-2xl font-bold text-gray-900">{{ $t('Create user') }}</h1>
                                <p class="text-sm text-gray-500 mt-1 flex items-center space-x-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                        class="text-[#ff5100]">
                                        <path fill="currentColor"
                                            d="M11 7h2v2h-2zm0 4h2v6h-2zm1-9C6.48 2 2 6.48 2 12s4.48 10 10 10s10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8s8 3.59 8 8s-3.59 8-8 8z" />
                                    </svg>
                                    <span>{{ $t('Add a new user to the system') }}</span>
                                </p>
                            </div>
                        </div>
                        <Link href="/admin/users"
                            class="px-6 py-3 bg-white hover:bg-gray-50 text-gray-700 rounded-xl font-medium transition-all duration-200 border-2 border-gray-200 hover:border-gray-300 flex items-center space-x-2 shadow-sm w-fit">
                        <ArrowLeft class="w-4 h-4" />
                        <span>{{ $t('Back') }}</span>
                        </Link>
                    </div>
                </div>
            </div>

            <!-- Header Section for Edit -->
            <div v-if="props.user" class="mb-8">
                <div class="bg-white rounded-3xl shadow-md border-2 border-primary/10 p-6 md:p-8">
                    <div class="flex flex-col lg:flex-row lg:items-start lg:justify-between gap-6">
                        <div class="flex items-start space-x-4">
                            <!-- Avatar -->
                            <div class="flex-shrink-0 relative group">
                                <div v-if="user.avatar"
                                    class="w-20 h-20 rounded-2xl overflow-hidden shadow-lg ring-4 ring-orange-100">
                                    <img class="w-full h-full object-cover" :src="user.avatar" :alt="user.full_name">
                                </div>
                                <div v-else
                                    class="w-20 h-20 bg-gradient-to-br from-[#ff5100] to-[#ff7733] rounded-2xl flex items-center justify-center shadow-lg ring-4 ring-orange-100">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24"
                                        class="text-white">
                                        <path fill="currentColor"
                                            d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10s10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3s-3-1.34-3-3s1.34-3 3-3zm0 14.2a7.2 7.2 0 0 1-6-3.22c.03-1.99 4-3.08 6-3.08c1.99 0 5.97 1.09 6 3.08a7.2 7.2 0 0 1-6 3.22z" />
                                    </svg>
                                </div>
                                <div
                                    class="absolute -bottom-1 -right-1 w-7 h-7 bg-green-500 rounded-full border-4 border-white shadow-sm">
                                </div>
                            </div>

                            <!-- User Info -->
                            <div class="flex-1">
                                <h1 class="text-2xl font-bold text-gray-900 mb-1">{{ props.user.full_name }}</h1>
                                <div class="flex items-center space-x-2 text-gray-600">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                        class="text-gray-400">
                                        <path fill="currentColor"
                                            d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5l-8-5V6l8 5l8-5v2z" />
                                    </svg>
                                    <span class="text-sm">{{ props.user.email }}</span>
                                </div>
                            </div>
                        </div>

                        <Link href="/admin/users"
                            class="px-6 py-3 bg-white hover:bg-gray-50 text-gray-700 rounded-xl font-medium transition-all duration-200 border-2 border-gray-200 hover:border-gray-300 flex items-center space-x-2 shadow-sm w-fit">
                        <ArrowLeft class="w-4 h-4" />
                        <span>{{ $t('Back') }}</span>
                        </Link>
                    </div>
                </div>
            </div>

            <!-- Tabs Section -->
            <div v-if="props.user"
                class="bg-white rounded-t-3xl shadow-md border-2 border-b-0 border-primary/10 px-6 pt-4">
                <div class="flex space-x-1 overflow-x-auto">
                    <button @click="changeTab('user')" type="button"
                        class="px-6 py-3 text-sm font-medium rounded-t-xl transition-all duration-200 whitespace-nowrap"
                        :class="tab === 'user'
                            ? 'bg-gradient-to-br from-[#ff5100] to-[#ff6622] text-white shadow-md'
                            : 'text-gray-600 hover:bg-orange-50 hover:text-[#ff5100]'">
                        <div class="flex items-center space-x-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24">
                                <path fill="currentColor"
                                    d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4s-4 1.79-4 4s1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" />
                            </svg>
                            <span>{{ $t('User details') }}</span>
                        </div>
                    </button>
                    <button @click="changeTab('organization')" type="button"
                        class="px-6 py-3 text-sm font-medium rounded-t-xl transition-all duration-200 whitespace-nowrap"
                        :class="tab === 'organization'
                            ? 'bg-gradient-to-br from-[#ff5100] to-[#ff6622] text-white shadow-md'
                            : 'text-gray-600 hover:bg-orange-50 hover:text-[#ff5100]'">
                        <div class="flex items-center space-x-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24">
                                <path fill="currentColor"
                                    d="M12 7V3H2v18h20V7H12zM6 19H4v-2h2v2zm0-4H4v-2h2v2zm0-4H4V9h2v2zm0-4H4V5h2v2zm4 12H8v-2h2v2zm0-4H8v-2h2v2zm0-4H8V9h2v2zm0-4H8V5h2v2zm10 12h-8v-2h2v-2h-2v-2h2v-2h-2V9h8v10zm-2-8h-2v2h2v-2zm0 4h-2v2h2v-2z" />
                            </svg>
                            <span>{{ $t('Organization details') }}</span>
                        </div>
                    </button>
                </div>
            </div>

            <!-- Organization Tab Content -->
            <div v-if="props.user && tab === 'organization'"
                class="bg-white rounded-b-3xl shadow-md border-2 border-t-0 border-primary/10 p-6">
                <OrganizationTable :rows="props.organizations" :filters="props.filters" />
            </div>

            <!-- User Form -->
            <form v-if="tab === 'user'" @submit.prevent="submitForm()"
                :class="props.user ? 'bg-white rounded-b-3xl shadow-md border-2 border-t-0 border-primary/10' : 'bg-white rounded-3xl shadow-md border-2 border-primary/10'">

                <!-- User Details Section -->
                <div class="p-6 md:p-8 border-b-2 border-gray-100">
                    <div class="flex flex-col lg:flex-row lg:space-x-12">
                        <div class="lg:w-2/5 mb-6 lg:mb-0">
                            <div class="flex items-start space-x-3">
                                <div
                                    class="w-10 h-10 bg-gradient-to-br from-[#ff5100] to-[#ff7733] rounded-xl flex items-center justify-center flex-shrink-0">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                        class="text-white">
                                        <path fill="currentColor"
                                            d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10s10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3s-3-1.34-3-3s1.34-3 3-3zm0 14.2a7.2 7.2 0 0 1-6-3.22c.03-1.99 4-3.08 6-3.08c1.99 0 5.97 1.09 6 3.08a7.2 7.2 0 0 1-6 3.22z" />
                                    </svg>
                                </div>
                                <div>
                                    <h3 class="text-lg font-bold text-gray-900">{{ $t('User details') }}</h3>
                                    <p class="text-sm text-gray-500 mt-1">{{ $t('Personal information and credentials')
                                    }}</p>
                                </div>
                            </div>
                        </div>
                        <div class="lg:w-3/5">
                            <div class="grid gap-6 sm:grid-cols-2">
                                <div class="sm:col-span-2">
                                    <FormImage v-model="form.avatar" :name="$t('Avatar')" :error="form.errors.avatar"
                                        :label="$t('Upload image')"
                                        :imageUrl="props.user?.avatar ? '/media/' + props.user?.avatar : null" />
                                </div>
                                <FormInput v-model="form.first_name" :name="$t('First name')"
                                    :error="form.errors.first_name" :type="'text'" />
                                <FormInput v-model="form.last_name" :name="$t('Last name')"
                                    :error="form.errors.last_name" :type="'text'" />
                                <FormInput v-model="form.email" :name="$t('Email')" :error="form.errors.email"
                                    :type="'text'" />
                                <FormPhoneInput v-model="form.phone" :name="$t('Phone')" :error="form.errors.phone"
                                    :type="'text'" />
                                <FormInput v-if="!props.user" v-model="form.password" :name="$t('Password')"
                                    :error="form.errors.password" :type="'password'" />
                                <FormInput v-if="!props.user" v-model="form.password_confirmation"
                                    :name="$t('Confirm password')" :error="form.errors.password_confirmation"
                                    :type="'password'" />
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Organization Section (Only for Create) -->
                <div v-if="!props.user" class="p-6 md:p-8 border-b-2 border-gray-100">
                    <div class="flex flex-col lg:flex-row lg:space-x-12">
                        <div class="lg:w-2/5 mb-6 lg:mb-0">
                            <div class="flex items-start space-x-3">
                                <div
                                    class="w-10 h-10 bg-gradient-to-br from-[#ff5100] to-[#ff7733] rounded-xl flex items-center justify-center flex-shrink-0">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                        class="text-white">
                                        <path fill="currentColor"
                                            d="M12 7V3H2v18h20V7H12zM6 19H4v-2h2v2zm0-4H4v-2h2v2zm0-4H4V9h2v2zm0-4H4V5h2v2zm4 12H8v-2h2v2zm0-4H8v-2h2v2zm0-4H8V9h2v2zm0-4H8V5h2v2zm10 12h-8v-2h2v-2h-2v-2h2v-2h-2V9h8v10zm-2-8h-2v2h2v-2zm0 4h-2v2h2v-2z" />
                                    </svg>
                                </div>
                                <div>
                                    <h3 class="text-lg font-bold text-gray-900">{{ $t('Organization') }}</h3>
                                    <p class="text-sm text-gray-500 mt-1">{{ $t('Associate user with an organization')
                                    }}</p>
                                </div>
                            </div>
                        </div>
                        <div class="lg:w-3/5">
                            <div class="space-y-6">
                                <!-- Create Organization Toggle -->
                                <div
                                    class="bg-gradient-to-br from-orange-50 to-orange-100/50 rounded-2xl p-5 border-2 border-orange-200">
                                    <FormCheckbox @input="toggleCreateOrganization" v-model="create_organization"
                                        :name="$t('Create organization')" :label="$t('Create organization')"
                                        :value="'organization'" :type="'checkbox'" />
                                </div>

                                <!-- Organization Name Input -->
                                <div v-if="create_organization" class="transform transition-all duration-300">
                                    <FormInput v-model="form.organization_name" :name="$t('Organization name')"
                                        :error="form.errors.organization_name" :type="'text'" />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Address Details Section -->
                <div class="p-6 md:p-8">
                    <div class="flex flex-col lg:flex-row lg:space-x-12">
                        <div class="lg:w-2/5 mb-6 lg:mb-0">
                            <div class="flex items-start space-x-3">
                                <div
                                    class="w-10 h-10 bg-gradient-to-br from-[#ff5100] to-[#ff7733] rounded-xl flex items-center justify-center flex-shrink-0">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                        class="text-white">
                                        <path fill="currentColor"
                                            d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5s2.5 1.12 2.5 2.5s-1.12 2.5-2.5 2.5z" />
                                    </svg>
                                </div>
                                <div>
                                    <h3 class="text-lg font-bold text-gray-900">{{ $t('Address details') }}</h3>
                                    <p class="text-sm text-gray-500 mt-1">{{ $t('User location information') }}</p>
                                </div>
                            </div>
                        </div>
                        <div class="lg:w-3/5">
                            <div class="grid gap-6 sm:grid-cols-2">
                                <div class="sm:col-span-2">
                                    <FormInput v-model="form.street" :name="$t('Street')" :error="form.errors.street"
                                        :type="'text'" />
                                </div>
                                <FormInput v-model="form.city" :name="$t('City')" :error="form.errors.city"
                                    :type="'text'" />
                                <FormInput v-model="form.state" :name="$t('State')" :error="form.errors.state"
                                    :type="'text'" />
                                <FormInput v-model="form.zip" :name="$t('Zip code')" :error="form.errors.zip"
                                    :type="'text'" />
                                <FormInput v-model="form.country" :name="$t('Country')" :error="form.errors.country"
                                    :type="'text'" />
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Submit Button -->
                <div class="px-6 md:px-8 pb-6 md:pb-8 pt-4 border-t-2 border-gray-100">
                    <div class="flex justify-end">
                        <button type="submit" :disabled="form.processing"
                            :class="['px-8 py-3 bg-gradient-to-r from-[#ff5100] to-[#ff6622] hover:from-[#ff6622] hover:to-[#ff5100] text-white rounded-xl font-medium transition-all duration-200 shadow-lg hover:shadow-xl flex items-center space-x-2', { 'opacity-50 cursor-not-allowed': form.processing }]">
                            <svg v-if="form.processing" xmlns="http://www.w3.org/2000/svg" width="20" height="20"
                                viewBox="0 0 24 24" class="animate-spin">
                                <path fill="currentColor"
                                    d="M12 2A10 10 0 1 0 22 12A10 10 0 0 0 12 2Zm0 18a8 8 0 1 1 8-8A8 8 0 0 1 12 20Z"
                                    opacity=".5" />
                                <path fill="currentColor" d="M20 12h2A10 10 0 0 0 12 2V4A8 8 0 0 1 20 12Z" />
                            </svg>
                            <svg v-else xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24">
                                <path fill="currentColor"
                                    d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3s3 1.34 3 3s-1.34 3-3 3zm3-10H5V5h10v4z" />
                            </svg>
                            <span v-if="form.processing">{{ $t('Saving...') }}</span>
                            <span v-else>{{ $t('Save') }}</span>
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </AppLayout>
</template>

<script setup>
import AppLayout from "./../Layout/App.vue";
import { ref } from 'vue';
import { Link, useForm } from "@inertiajs/vue3";
import FormCheckbox from '@/Components/FormCheckbox.vue';
import FormImage from '@/Components/FormImage.vue';
import FormInput from '@/Components/FormInput.vue';
import FormPhoneInput from '@/Components/FormPhoneInput.vue';
import OrganizationTable from '@/Components/Tables/OrganizationTable.vue';
import { ArrowLeft } from "lucide-vue-next";

const props = defineProps({
    title: String,
    user: Object,
    roles: Object,
    organizations: Object,
    filters: Object
});

const create_organization = ref(false);
const tab = ref('user');

const getAddressDetail = (value, key) => {
    if (value) {
        const address = JSON.parse(value);
        return address?.[key] ?? null;
    } else {
        return null;
    }
};

const toggleCreateOrganization = () => {
    if (!create_organization.value) {
        form.organization_name = null;
    } else {
        form.organization_name = undefined;
    }
}

const form = useForm({
    first_name: props.user?.first_name,
    last_name: props.user?.last_name,
    email: props.user?.email,
    phone: props.user?.phone,
    role: props.user?.role?.uuid,
    avatar: undefined,
    street: getAddressDetail(props.user?.address, 'street'),
    city: getAddressDetail(props.user?.address, 'city'),
    state: getAddressDetail(props.user?.address, 'state'),
    zip: getAddressDetail(props.user?.address, 'zip'),
    country: getAddressDetail(props.user?.address, 'country'),
    ...(props.user ? {} : { password: null, password_confirmation: null }),
    organization_name: undefined,
});

const changeTab = (value) => {
    tab.value = value;
}

const submitForm = async () => {
    const url = props.user ? window.location.pathname : '/admin/users';

    form[props.user ? 'put' : 'post'](url, {
        preserveScroll: true,
    });
};
</script>